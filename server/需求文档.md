### 📋 接口需求文档：PP-OCRv5 通用文字识别 (v2.1 - PDF Fully Implemented)

#### 1\. 接口概览 (Interface Overview)

| 项目 | 内容 | 备注 |
| :--- | :--- | :--- |
| **接口名称** | PP-OCRv5 通用文字识别 | 百度 AI Studio 服务化部署 |
| **请求协议** | HTTP / HTTPS | |
| **请求方法** | `POST` | |
| **请求路径** | `/ocr` | 需配合控制台分配的 Base URL 使用 |
| **数据格式** | `application/json` | |
| **鉴权方式** | Token 认证 | Header 中携带访问令牌 |

-----

#### 2\. 请求头定义 (Request Headers)

| 参数名 | 值示例 | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `Content-Type` | `application/json` | **是** | 指定负载格式 |
| `Authorization`| `token <Access_Token>` | **是** | **注意格式**：Token 值前需加 "token " 前缀（含空格） |

-----

#### 3\. 请求体参数 (Request Body)

**数据结构**：JSON Object

| 参数名 | 类型 | 必填 | 默认值 | 有效范围 | 说明与业务逻辑 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **`file`** | String | **是** | - | - | **输入文件数据**。<br>1. **Base64**：图像或 PDF 内容的 Base64 编码字符串。<br>2. **URL**：服务器可访问的图像或 PDF 链接。 |
| `fileType` | Integer | 否 | `1` | 0, 1 | **文件类型**。<br>`1`: 图像文件<br>`0`: PDF 文件 ✅ **Implemented** |
| `useDocOrientationClassify` | Boolean | 否 | `false` | - | **文档方向矫正**。<br>是否识别并矫正 0°/90°/180°/270° 旋转的图片。 |
| `useDocUnwarping` | Boolean | 否 | `false` | - | **图片扭曲矫正**。<br>是否矫正弯曲、褶皱或倾斜的文档图片。 |
| `useTextlineOrientation` | Boolean | 否 | `false` | - | **文本行方向矫正**。<br>针对具体文本行进行 0°/180° 翻转判断。 |
| `textDetLimitSideLen` | Integer | 否 | `64` | ≥64 | **图像长边限制**。<br>图像预处理时的长边限制值，值越大显存占用越高。 |
| `textDetThresh` | Number | 否 | `0.3` | [0.0, 1.0] | **检测像素阈值**。<br>像素点得分大于该值才判定为文字像素。 |
| `textDetBoxThresh` | Number | 否 | `0.6` | [0.0, 1.0] | **检测框阈值**。<br>检测框内平均得分大于该值才判定为文字区域。 |
| `textDetUnclipRatio` | Number | 否 | `1.5` | [1.0, 3.0] | **检测扩张系数**。<br>控制检测框的大小，值越大框越宽。 |
| `textRecScoreThresh` | Number | 否 | `0.0` | [0.0, 1.0] | **识别置信度阈值**。<br>识别结果得分低于该值的文本将被过滤丢弃。 |
| `visualize` | Boolean | 否 | `false` | - | **开启可视化**。<br>`true`: 返回结果中包含带检测框的图片 URL（增加耗时）。 |
| `pdfDpi` | Integer | 否 | `150` | [72, 300] | **PDF 渲染 DPI**（仅 fileType=0 时有效）。<br>值越大图像越清晰但内存占用越高。 |
| `pdfMaxPages` | Integer | 否 | `10` | [1, 100] | **PDF 最大处理页数**（仅 fileType=0 时有效）。<br>超出限制的页面不会被处理。 |

-----

#### 4\. 响应体结构 (Response Body)

**图像 OCR 成功响应 (HTTP 200, fileType=1)**

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `logId` | String | 请求唯一标识 (UUID)，用于排查问题。 |
| `errorCode` | Integer | 状态码，`0` 表示成功。 |
| `errorMsg` | String | 状态信息，成功时为 `"Success"`。 |
| `result` | Object | 具体的业务数据对象。 |
| └ `ocrResults` | Array | 识别结果列表。 |
|   └ `prunedResult` | String | **核心字段**：识别出的文本内容。 |
|   └ `score` | Number | 识别置信度分数。 |
|   └ `points` | Array | 文本框四个顶点坐标。 |
| └ `ocrImage` | String | (当 `visualize=true` 时) 可视化结果图的 URL。 |

**PDF OCR 成功响应 (HTTP 200, fileType=0)**

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `logId` | String | 请求唯一标识 (UUID)。 |
| `errorCode` | Integer | 状态码，`0` 表示成功。 |
| `errorMsg` | String | 状态信息，成功时为 `"Success"`。 |
| `result` | Object | 具体的业务数据对象。 |
| └ `totalPages` | Integer | PDF 文件总页数。 |
| └ `renderedPages` | Integer | 实际处理的页数。 |
| └ `warning` | String | (可选) 页数被截断时的警告信息。 |
| └ `pages` | Array | 每页的 OCR 结果数组。 |
|   └ `pageIndex` | Integer | 页码索引（从 0 开始）。 |
|   └ `ocrResults` | Array | 该页的识别结果列表（同图像格式）。 |

**失败响应**

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `logId` | String | 请求唯一标识 (UUID)。 |
| `errorCode` | Integer | 非 `0` 值 (详见错误码表)。 |
| `errorMsg` | String | 具体的错误描述信息。 |

-----

#### 5\. 错误码参考 (Error Codes)

| errorCode | HTTP 状态码 | 说明 |
| :--- | :--- | :--- |
| 0 | 200 | 成功 |
| 1001 | 400 | 参数错误（参数格式不正确或超出有效范围） |
| 1002 | 400 | PDF 文件无法打开 |
| 1003 | 400 | PDF 格式无效或文件损坏 |
| 1004 | 401 | PDF 需要密码 |
| 1005 | 403 | PDF 安全策略不支持 |
| 1006 | 400 | PDF 页面不存在 |
| 1007 | 400 | PDF 页面尺寸异常 |
| 1008 | 400 | PDF 页数超出限制 |
| 1009 | 400 | PDF DPI 超出限制 |
| 2001 | 500 | 服务内部错误 |
| 2002 | 503 | 内存分配失败 |
| 2003 | 504 | PDF 渲染超时 |
| 3001 | 401 | 认证失败 |

-----

#### 6\. 请求示例

**图像 OCR 请求**

```bash
curl -X POST http://localhost:8080/ocr \
  -H "Content-Type: application/json" \
  -H "Authorization: token your_token" \
  -d '{
    "file": "<base64_encoded_image>",
    "fileType": 1,
    "textDetThresh": 0.3,
    "visualize": true
  }'
```

**PDF OCR 请求**

```bash
curl -X POST http://localhost:8080/ocr \
  -H "Content-Type: application/json" \
  -H "Authorization: token your_token" \
  -d '{
    "file": "<base64_encoded_pdf>",
    "fileType": 0,
    "pdfDpi": 150,
    "pdfMaxPages": 10
  }'
```

**PDF OCR 请求（使用文件）**

```bash
# 1. 将 PDF 编码为 Base64 并生成 JSON 请求
PDF_BASE64=$(base64 -w0 document.pdf)
cat > request.json << EOF
{
  "file": "$PDF_BASE64",
  "fileType": 0,
  "pdfDpi": 150,
  "pdfMaxPages": 100
}
EOF

# 2. 发送请求
curl -X POST http://localhost:8080/ocr \
  -H "Content-Type: application/json" \
  -H "Authorization: token your_token" \
  -d @request.json
```

-----

#### 7\. PDF 处理注意事项

1. **内存消耗**：PDF 渲染会消耗较多内存，A4 页面 @ 150 DPI 约 8.7MB/页
2. **推荐配置**：
   - 一般文档：`pdfDpi=150`，`pdfMaxPages=10`
   - 高清需求：`pdfDpi=200`，`pdfMaxPages=5`
   - 大批量处理：`pdfDpi=100`，`pdfMaxPages=20`
3. **并行处理**：多页 PDF 采用并行渲染和并行 OCR 处理，提高吞吐量
4. **不支持的 PDF**：加密 PDF、带密码 PDF、损坏的 PDF 文件会返回相应错误码
5. **页数限制**：当 PDF 总页数超过 `pdfMaxPages` 时，仅处理前 N 页，响应中会包含 `warning` 字段

-----

#### 8\. 服务启动方式

```bash
# 设置环境变量
source ./set_env.sh 1 2 1 3 2 4

# 启动服务
cd server
./run_server.sh
```

-----

#### 9\. 自动化测试工具

**PDF OCR 批量测试**

```bash
cd server/benchmark

# 将待测试的 PDF 文件放入 pdf_file/ 目录

# 运行测试（自动处理所有 PDF）
python3 pdf_ocr_test.py -v

# 测试结果保存在 result/ 目录
```

**测试脚本功能**

- 自动扫描 `pdf_file/` 目录中的 PDF 文件
- 自动将 PDF 转换为 Base64 编码
- 自动生成 JSON 请求并发送
- 自动设置合适的 `pdfMaxPages`
- 结果保存为 `<pdf名>_OCR_result.json`
